## 日期：2025年6月28日
## 專案日誌：MQ 直立式廣告機內容管理系統 v3.6
---
### 🚀 新增功能
1. **群組圖片上傳體驗優化**
   - 圖片上傳成功後，不再彈出「上傳成功」提示，也不再自動重新整理頁面。
   - 而是即時更新「已選圖片」和「所有可用圖片」列表，提升使用者操作流暢度。

### 🛠️ 更新-改進
1. **前端 API 呼叫邏輯強化**
   - 統一使用 `fetchWithAuth` 處理所有需要 JWT 認證的 API 請求，確保 Token 正確傳遞。
   - 攔截表單預設提交行為，改為透過 JavaScript 發送非同步請求。
2. **後端 API 支援擴展**
   - 新增 `/api/assignments/<assignment_id>` 的 `DELETE` 路由，支援前端刪除指派操作。
3. **後台介面重構**
   - 根據新的線框圖 (New Mockup 1.png) 重新設計 `admin.html` 頁面佈局。
   - 使用 Bulma CSS 的 `columns` 和 `column` class 實現了 2x2 的網格佈局，將四個主要功能區塊（新增媒體、全局設定、媒體庫、輪播組管理）重新排列。
   - 提升了頁面的視覺清晰度和操作直覺性。
   **CSS 樣式外部化**
   - 將原先在 `admin.html` 中所有的內聯 `<style>` 規則抽取出來。
   - 建立了一個新的專用樣式表 `static/css/admin.css` 來存放這些規則。
   - `admin.html` 現在透過 `<link>` 標籤引用此外部樣式表，使 HTML 結構更乾淨，也讓樣式更易於管理和快取。
4. **前端無刷新更新 (SPA 模式)**
   - 引入 `appState` 作為前端資料的單一來源，實現資料驅動的 UI 更新。
   - 建立 `renderMediaAndAssignments()` 和 `renderCarouselGroups()` 等渲染函式，動態更新頁面內容。
   - 改造 WebSocket 監聽器，使其在收到更新通知時，觸發資料重新獲取並渲染，而非強制刷新頁面。
   - 重構「新增媒體/指派內容」及「全局播放設定」表單提交邏輯，實現無刷新更新。
5. **上傳進度條功能**
   - 將檔案上傳機制從 `fetch` API 替換為 `XMLHttpRequest`，以支援上傳進度追蹤並顯示進度條。
6. **移除多餘的成功提示**
   - 移除刪除素材、指派、輪播組，以及建立輪播組、指派輪播組成功後彈出的多餘提示框，提升操作流暢度。
7. **優化內部指派邏輯**
   - 建立 `_create_assignment_record` 輔助函式，統一處理指派記錄的建立，確保邏輯清晰與原子性。
   - 調整單一媒體指派邏輯，使其為「追加」而非「覆蓋」，允許同一區塊有多個單一媒體輪播。
8. **輪播群組圖片上傳後 Modal 不關閉**
   - 移除群組圖片上傳成功後觸發的 WebSocket 廣播，使編輯 Modal 保持開啟狀態，提升使用者體驗。

### 🐛 BUG 修復
- **`POST /api/materials 400 (BAD REQUEST)` 錯誤**：
  - 修正了前端未傳遞 `block_id` 導致的 400 錯誤。
  - 修正後端 `create_assignment` 函式對 `type` 參數的識別問題，使其能正確處理 `image`、`video` 和 `single_media` 類型。
  - 修正了 `upload_material` 函式中，在素材 ID 尚未生成時就嘗試使用的邏輯錯誤，確保 ID 在指派前已有效。
- **「素材上傳成功，但指派失敗」錯誤**：
  - 修正了 `_create_assignment_record` 函式中，單一媒體指派時錯誤地刪除所有舊指派的問題，使其僅在指派輪播組時執行覆蓋操作。
- **刪除操作「Method Not Allowed」錯誤**：
  - 修正了前端刪除素材、指派、輪播群組時，因 HTTP 方法不正確導致的「Method Not Allowed」錯誤。
  - 確保前端對應的 `DELETE` 或 `POST` 請求發送到正確的後端 API 端點。
- **刪除輪播群組時圖片清理不完整**：
  - 修正了刪除輪播群組時，未能正確清理所有群組專屬圖片的問題。
  - 優化了後端查詢邏輯，確保所有相關圖片都能被正確刪除。
- **建立群組「Token is missing!」錯誤**：
  - 解決了建立輪播群組時，因未攜帶 JWT 認證資訊導致的「Token is missing!」錯誤。
  - 前端現在會正確地將 JWT Token 包含在建立群組的請求中。
- **指派輪播組時「指派到區塊」下拉選單消失**：
  - 修正了在「新增媒體 / 指派內容」中選擇「指派輪播組」時，區塊下拉選單錯誤隱藏的問題。
  - 確保 `toggleFormFields` 函式在處理 `group_reference` 類型時，正確顯示相關欄位。
- **指派輪播組時「不支援的操作類型」錯誤**：
  - 解決了前端傳遞的 `type` 值與後端預期不符導致的「不支援的操作類型」錯誤。
  - 將前端 `templates/admin.html` 中「指派輪播組」選項的 `value` 從 `carousel_reference` 修改為 `group_reference`，使其與後端匹配。
- **媒體庫顯示錯誤（全部未指派）**：
  - 修正了後端 `/api/media_with_settings` API 未返回指派資料的問題，確保前端能正確渲染素材狀態。
- **「新增媒體/指派內容」下拉選單消失**：
  - 修正了 `toggleFormFields()` 函式未在頁面載入時被呼叫的問題，導致指派下拉選單隱藏。
- **上傳進度條不見**：
  - 修正了上傳進度條的顯示/隱藏邏輯，確保其在檔案上傳過程中正常顯示。
- **「正在驗證身份...」無限讀取**：
  - 修正了 `admin.js` 中隱藏載入畫面程式碼被誤刪的問題。
  - 修正了 `admin.html` 和 `admin.js` 中重複初始化 `socket` 物件導致的 JavaScript 錯誤。

### 📝 備註
- 本次更新主要集中於提升前端互動的穩定性與使用者體驗，並完善了後端 API 的支援。
- 透過前端重構，實現了後台操作的無刷新更新，大幅提升使用者體驗。

### 📅 未來計劃
- **後端 API 重構**：將目前混合的 API 端點（如 `/admin/add`）重構為更符合 RESTful 風格的資源導向 API。
- **資料庫整合**：將 `media.json` 和 `settings.json` 的資料遷移至 SQLite 資料庫，以提升資料一致性和查詢效率。
- **前端模組化**：將龐大的 `admin.js` 拆分為多個功能模組，並引入輕量級的狀態管理機制。
- **增加自動化測試**：為後端 API 和前端邏輯編寫單元測試，提升專案穩定性。
- **使用者管理**：新增後台使用者管理介面，允許管理員增刪改查使用者。
