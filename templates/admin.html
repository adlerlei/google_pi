<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQ 內容管理系統</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bulma.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        #upload-progress-container { display: none; margin-top: 1rem; }
        .media-list-table td, .media-list-table th { vertical-align: middle; }
        .image-thumbnail { width: 64px; height: 64px; object-fit: cover; margin-right: 10px; border: 1px solid #dbdbdb; border-radius: 4px; }
        .media-item-entry { display: flex; align-items: center; justify-content: space-between; padding: 0.5em 0; border-bottom: 1px solid #eee; }
        .media-item-entry:last-child { border-bottom: none; }
        .available-images-list, .selected-images-list { max-height: 300px; overflow-y: auto; border: 1px solid #dbdbdb; padding: 10px; border-radius: 4px; }
        .draggable-item { cursor: grab; }
        .dragging { opacity: 0.5; background: #f0f0f0; }
        .drag-placeholder { height: 2px; background-color: rgba(0, 123, 255, 0.5); margin: 5px 0; }
        .selected-images-list.drag-over-active { border: 2px dashed #007bff; }
        .table-section-header th { background-color: #f5f5f5; font-weight: bold; text-align: center; }
        .icon-tag { display: flex; align-items: center; gap: 8px; }
        .navbar-item.has-text-grey-light { color: #dbdbdb !important; }
    </style>
</head>
<body>
    <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item has-text-weight-bold" href="#">
                    MQ 內容管理系統
                </a>
            </div>
            <div class="navbar-menu">
                <div class="navbar-end">
                    <span class="navbar-item has-text-grey-light">
                        <span class="icon is-small mr-2">
                            <i class="fas fa-user"></i>
                        </span>
                        歡迎, {{ username }}
                    </span>
                    <div class="navbar-item">
                        <div class="buttons">
                            <button id="logoutButton" class="button is-primary is-light">
                                登出
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
             <div class="box mt-5">
                <h2 class="title is-4">新增媒體/指派內容</h2>
                <form id="uploadForm" action="{{ url_for('add_media_item') }}" method="POST" enctype="multipart/form-data">
                    </form>
            </div>

            <div class="box mt-5">
                <h2 class="title is-4">全局播放設定</h2>
                {# settings 是從後端傳遞過來的字典 #}
                {% set current_settings = settings if settings else {} %}
                <div id="settings-notification" class="notification is-hidden"></div>
                <form id="globalSettingsForm">
                    <div class="field">
                        <label class="label" for="header_interval">頁首內容輪播間隔時間 (秒)</label>
                        <div class="control">
                            <input class="input" type="number" id="header_interval" name="header_interval" 
                                   value="{{ current_settings.get('header_interval', 5) }}" min="1" required>
                        </div>
                        <p class="help">適用於頁首區域有多個內容時的輪播間隔。</p>
                    </div>
                    <div class="field">
                        <label class="label" for="carousel_interval">中間區塊圖片輪播間隔時間 (秒)</label>
                        <div class="control">
                            <input class="input" type="number" id="carousel_interval" name="carousel_interval" 
                                   value="{{ current_settings.get('carousel_interval', 6) }}" min="1" required>
                        </div>
                        <p class="help">適用於所有四個中間輪播區塊。</p>
                    </div>
                    <div class="field">
                        <label class="label" for="footer_interval">頁尾內容輪播間隔時間 (秒)</label>
                        <div class="control">
                            <input class="input" type="number" id="footer_interval" name="footer_interval" 
                                   value="{{ current_settings.get('footer_interval', 7) }}" min="1" required>
                        </div>
                        <p class="help">適用於頁尾區域有多個內容時的輪播間隔。</p>
                    </div>
                    <div class="field is-grouped is-grouped-right">
                        <div class="control">
                            <button type="submit" class="button is-info" id="saveSettingsButton">儲存播放設定</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="box mt-5">
                <h2 class="title is-4">媒體庫與區塊內容指派</h2>
                {% set assignments = media_items | selectattr('type', 'equalto', 'section_assignment') | list %}
                {% set materials = media_items | selectattr('type', 'in', ['image', 'video']) | list %}
                {% set used_material_ids = [] %}
                <div class="table-container">
                    <table class="table is-striped is-fullwidth is-hoverable media-list-table">
                        </table>
                </div>
            </div>

        </div>
    </section>

    <div id="editCarouselGroupModal" class="modal">
        </div>

    <div id="editAssignmentModal" class="modal">
        </div>

    <script>
        const allMediaItemsForJS = {{ media_items | tojson }};
        const availableImageSources = allMediaItemsForJS.filter(item => item.type === 'image');
        const available_sections_for_js = {{ available_sections | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
</body>
</html>