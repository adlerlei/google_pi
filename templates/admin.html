<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQ 內容管理系統</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bulma.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        #upload-progress-container { display: none; margin-top: 1rem; }
        .media-list-table td, .media-list-table th { vertical-align: middle; }
        .image-thumbnail { width: 64px; height: 64px; object-fit: cover; margin-right: 10px; border: 1px solid #dbdbdb; border-radius: 4px; }
        .media-item-entry { display: flex; align-items: center; justify-content: space-between; padding: 0.5em 0; border-bottom: 1px solid #eee; }
        .media-item-entry:last-child { border-bottom: none; }
        .available-images-list, .selected-images-list { max-height: 300px; overflow-y: auto; border: 1px solid #dbdbdb; padding: 10px; border-radius: 4px; }
        .draggable-item { cursor: grab; }
        .dragging { opacity: 0.5; background: #f0f0f0; }
        .drag-placeholder { height: 2px; background-color: rgba(0, 123, 255, 0.5); margin: 5px 0; }
        .selected-images-list.drag-over-active { border: 2px dashed #007bff; }
        .table-section-header th { background-color: #f5f5f5; font-weight: bold; text-align: center; }
        .icon-tag { display: flex; align-items: center; gap: 8px; }
    </style>
</head>
<body>
    <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item has-text-weight-bold" href="#">
                    MQ 內容管理系統
                </a>
            </div>
            <div class="navbar-menu">
                <div class="navbar-end">
                    <div class="navbar-item">
                        <div class="buttons">
                            <button id="logoutButton" class="button is-primary is-light">
                                登出
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <section class="section">
        <div class="container">
             <div class="box mt-5">
                <h2 class="title is-4">新增媒體/指派內容</h2>
                <form id="uploadForm" action="{{ url_for('add_media_item') }}" method="POST" enctype="multipart/form-data">
                    </form>
            </div>

            <div class="box mt-5">
                <h2 class="title is-4">全局播放設定</h2>
                {% set current_settings = settings if settings else {} %}
                <div id="settings-notification" class="notification is-hidden"></div>
                <form id="globalSettingsForm">
                    <div class="field">
                        <label class="label" for="header_interval">頁首內容輪播間隔時間 (秒)</label>
                        <div class="control">
                            <input class="input" type="number" id="header_interval" name="header_interval" 
                                   value="{{ current_settings.get('header_interval', 5) }}" min="1" required>
                        </div>
                        <p class="help">適用於頁首區域有多個內容時的輪播間隔。</p>
                    </div>
                    <div class="field">
                        <label class="label" for="carousel_interval">中間區塊圖片輪播間隔時間 (秒)</label>
                        <div class="control">
                            <input class="input" type="number" id="carousel_interval" name="carousel_interval" 
                                   value="{{ current_settings.get('carousel_interval', 6) }}" min="1" required>
                        </div>
                        <p class="help">適用於所有四個中間輪播區塊。</p>
                    </div>
                    <div class="field">
                        <label class="label" for="footer_interval">頁尾內容輪播間隔時間 (秒)</label>
                        <div class="control">
                            <input class="input" type="number" id="footer_interval" name="footer_interval" 
                                   value="{{ current_settings.get('footer_interval', 7) }}" min="1" required>
                        </div>
                        <p class="help">適用於頁尾區域有多個內容時的輪播間隔。</p>
                    </div>
                    <div class="field is-grouped is-grouped-right">
                        <div class="control">
                            <button type="submit" class="button is-info" id="saveSettingsButton">儲存播放設定</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="box mt-5">
                <h2 class="title is-4">媒體庫與區塊內容指派</h2>
                {% set assignments = media_items | selectattr('type', 'equalto', 'section_assignment') | list %}
                {% set materials = media_items | selectattr('type', 'in', ['image', 'video']) | list %}
                {% set used_material_ids = [] %}
                <div class="table-container">
                    <table class="table is-striped is-fullwidth is-hoverable media-list-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-photo-film"></i> 預覽/資訊</th>
                                <th><i class="fas fa-tags"></i> 類型</th>
                                <th><i class="fas fa-map-pin"></i> 狀態/指派到區塊</th>
                                <th class="has-text-right"><i class="fas fa-cogs"></i> 操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if assignments %}
                                <tr class="table-section-header"><th colspan="4">區塊內容指派</th></tr>
                                {% for item in assignments %}
                                <tr>
                                    <td></td>
                                    <td>
                                        {% if item.content_source_type == 'single_media' %}
                                            <span class="tag is-primary icon-tag"><i class="fas fa-arrow-up-from-bracket"></i>直接指派</span>
                                        {% elif item.content_source_type == 'group_reference' %}
                                            <span class="tag is-link icon-tag"><i class="fas fa-layer-group"></i>輪播組指派</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>指派至：</strong> {{ available_sections.get(item.section_key, item.section_key) }}
                                        {% if item.content_source_type == 'group_reference' %}
                                            <br><small>偏移量: {{ item.offset }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="has-text-right">
                                        <div class="field is-grouped is-grouped-right">
                                            <p class="control">
                                                <button class="button is-small is-link is-light edit-assignment-button"
                                                        data-item-id="{{ item.id }}"
                                                        data-assignment-type="{{ item.content_source_type }}"
                                                        data-section-key="{{ item.section_key }}"
                                                        data-media-id="{{ item.media_id if item.content_source_type == 'single_media' else '' }}"
                                                        data-group-id="{{ item.group_id if item.content_source_type == 'group_reference' else '' }}"
                                                        data-offset="{{ item.offset if item.content_source_type == 'group_reference' else '0' }}">
                                                    編輯指派
                                                </button>
                                            </p>
                                            <p class="control">
                                                <form action="{{ url_for('delete_media_item', item_id_to_delete=item.id) }}" method="POST" onsubmit="return confirm('您確定要刪除這個「指派」記錄嗎？');">
                                                    <button type="submit" class="button is-small is-danger is-light">刪除</button>
                                                </form>
                                            </p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <div id="editCarouselGroupModal" class="modal">
    </div>

    <div id="editAssignmentModal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">編輯區塊指派</p>
                <button class="delete" aria-label="close"></button>
            </header>
            <section class="modal-card-body">
                <form id="editAssignmentForm">
                    <input type="hidden" id="editAssignmentId" name="assignment_id">
                    <input type="hidden" id="editAssignmentType" name="assignment_type">

                    <div class="field">
                        <label class="label">指派區塊</label>
                        <div class="control">
                            <input class="input" id="editSectionKeyDisplay" type="text" readonly>
                        </div>
                    </div>

                    <div id="editDirectAssignFields" style="display: none;">
                        <div class="field">
                            <label class="label">更換媒體素材</label>
                            <p class="help">目前素材: <span id="currentMediaFilename"></span></p>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="editMediaSelect" name="media_id">
                                        <option value="">-- 選擇新素材 --</option>
                                        {% for item in materials %}
                                            <option value="{{ item.id }}" data-type="{{ item.type }}">
                                                [{{ '圖片' if item.type == 'image' else '影片' }}] {{ item.filename }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="editGroupAssignFields" style="display: none;">
                        <div class="field">
                            <label class="label">更換輪播組</label>
                            <div class="control">
                                <div class="select is-fullwidth">
                                    <select id="editCarouselGroupSelect" name="group_id">
                                         {% for item in media_items %}
                                            {% if item.type == 'carousel_group' %}
                                            <option value="{{ item.id }}">{{ item.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                         <div class="field">
                            <label class="label">圖片順序偏移量</label>
                            <div class="control">
                                <input class="input" type="number" id="editOffsetInput" name="offset" value="0" min="0">
                            </div>
                            <p class="help">例如：0 表示從第一張開始，1 表示從第二張開始。</p>
                        </div>
                    </div>
                </form>
            </section>
            <footer class="modal-card-foot">
                <button id="saveAssignmentChangesButton" class="button is-success">儲存變更</button>
                <button class="button" id="cancelAssignmentChangesButton">取消</button>
            </footer>
        </div>
    </div>

    <script>
        const allMediaItemsForJS = {{ media_items | tojson }};
        const availableImageSources = allMediaItemsForJS.filter(item => item.type === 'image');
        const available_sections_for_js = {{ available_sections | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
</body>
</html>