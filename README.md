## 專案結構 (主要檔案)
google_pi
├── README.md
├── app.py
├── media.json
├── requirements.txt
├── static
│   ├── css
│   │   ├── bulma.css
│   │   └── style.css
│   ├── js
│   │   └── admin.js
│   └── uploads
└── templates
    └── admin.html

專案進度報告：MQ 直立式廣告機內容管理系統

最後更新日期： 2025年6月5日

專案概述

本專案旨在開發一個後台內容管理系統，用於管理 MQ 直立式廣告機前端頁面的顯示內容。使用者可以透過網頁後台 (admin.html) 上傳和管理媒體素材（圖片、影片），建立輪播圖片組，並將這些內容指派到廣告機前端 (index.html) 的特定顯示區塊（頁首、四個中間輪播區、頁尾）。系統支持即時內容更新。

一、已完成的主要開發功能

1. 後端 (app.py - Flask)

* **數據模型重構完成**:

    * **媒體素材 (`type: "image"`, `type: "video"`)**: 純粹的素材記錄，不直接帶有 `section_key`。包含 `id`, `filename`, `url`, `type`。

    * **輪播圖片組定義 (`type: "carousel_group"`)**: 包含 `id`, `type`, `name`, `image_ids` (引用媒體素材的 ID)。

    * **區塊內容指派 (`type: "section_assignment"`)**: 核心的指派記錄，包含 `id`, `type`, `section_key`, `content_source_type` (`single_media` 或 `group_reference`), 以及對應的 `media_id` 或 `group_id` 和 `offset`。

* **媒體上傳與指派邏輯**:

    * **上傳圖片/影片並直接指派**:

        * 成功上傳檔案到 `static/uploads` (使用 UUID 確保檔名唯一)。

        * 在 `media.json` 中同時創建「媒體素材記錄」和「區塊指派記錄 (`section_assignment` 與 `content_source_type: "single_media"`)」。

        * 對同一區塊的多次直接指派，實現內容**累加**效果（即一個區塊可以有多個 `section_assignment` 指向不同的單一媒體）。

    * **指派輪播組到中間輪播區塊**:

        * 創建 `section_assignment` 記錄 (與 `content_source_type: "group_reference"`)。

        * **正確實現覆蓋邏輯**: 新的輪播組指派會移除目標輪播區塊先前所有的 `section_assignment` 記錄（無論是單一媒體指派還是舊的輪播組指派）。

* **輪播圖片組管理**:

    * **建立輪播組**: 允許使用者輸入組名建立新的輪播組。

    * **更新組內圖片與順序**: 透過 `/admin/carousel_group/update_images/<group_id>` 路由，接收前端 Modal 提交的圖片 ID 順序，並更新 `media.json` 中對應輪播組的 `image_ids`。

* **刪除邏輯**:

    * **刪除媒體素材**: 會同時刪除實體檔案、素材記錄本身、所有引用此素材的 `section_assignment`，以及所有輪播組中對此素材的引用 (`image_ids`)。

    * **刪除輪播圖片組**: 會同時刪除組定義本身以及所有引用此組的 `section_assignment`。

    * **刪除區塊指派記錄**: 直接移除該 `section_assignment` 記錄。

* **API (`/api/media_with_settings`)**:

    * 正確根據新的數據模型組合前端所需的媒體數據。

    * 能夠處理一個區塊有多個直接指派的單一媒體。

    * 正確處理輪播組指派覆蓋直接指派的優先級。

    * 開始集成全局播放設定的返回 (後端已準備好 `settings.json` 及相關讀寫函數)。

* **WebSocket 即時更新**: 在後台數據變更時，通過 SocketIO 通知前端刷新。

* **全局播放設定基礎**:

    * 新增 `settings.json` 檔案用於儲存播放間隔時間。

    * 新增 `load_playback_settings()` 和 `save_playback_settings()` 函數。

    * 新增 `/admin/settings/update` 路由用於更新設定。

    * `admin_page` 路由會載入並傳遞設定給模板。

2. 後台管理介面 (admin.html & static/js/admin.js)

* **表單與操作邏輯**:

    * 「新增媒體/指派內容」表單：

        * 「操作類型」下拉選單（上傳圖片、上傳影片、指派輪播組）。

        * 根據「操作類型」動態顯示/隱藏相關欄位（指定區塊、選擇檔案、選擇輪播組、偏移量）。

        * 「指定區塊」下拉選單根據操作類型正確填充選項。

    * 文件上傳進度條。

* **輪播圖片組編輯 Modal**:

    * 正常開啟與關閉。

    * 正確填充可用素材列表和已選圖片列表。

    * 支持從可用素材中「加入」圖片到當前編輯的群組。

    * 支持從群組中「移除」圖片。

    * **拖曳排序功能已實現並運作正常 (在 Chrome 中)**。

    * 「儲存變更」按鈕能將排序後的圖片 ID 列表通過 AJAX 發送到後端。

* **列表顯示優化**:

    * 「媒體庫與區塊內容指派」列表：

        * 已調整 Jinja2 模板，更清晰地分開顯示「區塊內容指派」記錄和「未被使用的純素材」。

        * 移除了不必要的「素材ID」顯示。

        * 嘗試解決了刪除群組後可能出現的列表空行問題。

    * 「現有輪播圖片組」列表：正常顯示組名、圖片數量和操作按鈕。

* **全局播放設定區塊**:

    * 已在 `admin.html` 中新增 UI 元素（輸入框和儲存按鈕）。

    * 表單能正確提交到 `/admin/settings/update` 路由。

    * 輸入框能正確顯示和預填充從後端獲取的設定值。

* **瀏覽器兼容性處理**:

    * 針對 Arc 瀏覽器 `confirm()` 和 `alert()` 的特殊行為，調整了刪除功能的 JavaScript 處理方式。

3. 前端顯示頁面 (index.html & static/js/animation.js)

* **基礎結構**: 頁面包含頁首影片區、四個中間輪播區、頁尾內容區。

* **數據獲取**: `animation.js` 中的 `fetchMediaAndSettings()` 函數已修改為從 `/api/media_with_settings` 獲取媒體數據和播放設定。

* **中間輪播區塊**:

    * **能夠正確顯示由「輪播圖片組」指派的內容**，並根據偏移量進行輪播。

    * **能夠正確顯示由多次「直接上傳圖片」形成的累加內容**，並進行輪播。

    * 輪播間隔時間已能根據後端「全局播放設定」中的 `carousel_interval` 動態調整。

* **WebSocket 即時更新**: 正常運作，後台變更後前端會獲取最新數據並刷新。

二、尚待完善/正在進行的功能

=== 頁首/頁尾 影片，圖片混合輪播功能目前有進行中，似乎有點問題 ===

前端 static/js/animation.js 中頁首/頁尾的輪播功能:

目前 updateHeaderVideo() 和 updateFooterContent() 主要還是處理單一媒體的顯示。

需要修改這兩個函數，使其能夠處理從 /api/media_with_settings 獲取到的、針對其 section_key 的多個直接指派的媒體項目（圖片或影片）。

如果有多個項目，應在對應的 HTML 容器中創建輪播結構，並使用後端全局設定中的 header_interval 和 footer_interval 來實現輪播。

需要考慮圖片和影片混合輪播的情況。

========================================================

三、未來計劃開發的功能

「編輯指派」功能:

在「媒體庫與區塊內容指派」列表中，為「區塊內容指派」記錄啟用「編輯」按鈕。

允許使用者修改現有的指派，例如：

更改「直接指派」的媒體到另一個區塊，或更換素材。

更改「輪播組指派」的目標區塊、引用的輪播組或偏移量。

「編輯素材」功能:

為「未使用的素材」啟用「編輯素材」按鈕。

允許修改素材的元信息（如果將來有，例如標題、描述）或替換素材檔案。

更細緻的前端輪播效果與控制 (static/js/animation.js):

為頁首、頁尾和中間輪播區塊的輪播增加平滑的過渡動畫效果。

考慮是否需要為輪播添加手動控制項（例如左右箭頭、指示點）。

使用者體驗 (UX) 優化 (admin.html):

根據使用者反饋或進一步的設計稿，持續優化後台介面的佈局、操作流程和視覺呈現。

例如，在 Modal 編輯輪播組時，提供更豐富的圖片資訊或篩選功能。

提供更友好的錯誤提示和操作成功反饋。

系統健壯性與錯誤處理:

增強後端和前端的錯誤處理機制。

對使用者輸入進行更嚴格的驗證。

(可選) 使用者認證與權限管理: 如果系統需要多人使用或更高的安全性，可以考慮加入登入和權限控制功能。

這份進度文件旨在清晰地呈現專案的當前狀態和未來方向。