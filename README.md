# MQ 直立式廣告機內容管理系統

**版本：** v3.7
**最後更新日期：** 2025年6月29日

## 專案概述

本專案是一個輕量級的後台內容管理系統（CMS），專為「MQ 直立式廣告機」前端頁面設計。它提供了一個受密碼保護的管理介面，讓管理者能夠上傳媒體素材（圖片、影片）、管理輪播內容，並將這些素材即時指派到前端廣告機的特定顯示區塊。所有內容的變更都會透過 WebSocket 即時同步到前端頁面，無需重新整理。

### v3.7 版本亮點
- **資料庫穩定性修復**：解決了因檔案權限不足導致的資料庫唯讀錯誤 (`readonly database`)。
- **前端互動全面修復**：修正了因動態內容渲染導致的多項功能失效，包括：建立群組、編輯群組（彈窗開啟、圖片上傳、圖片新增/移除、拖曳排序、儲存變更）。
- **程式碼現代化**：將後端所使用的 SQLAlchemy 過時語法 (`query.get`) 更新為 `db.session.get`，消除 `LegacyAPIWarning`。
- **使用者介面優化**：修正了輪播群組編輯視窗中，預覽圖片過大的問題，改善視覺體驗。

### v3.6 版本亮點
- **後台介面重構**：根據新的線框圖重新設計 `admin.html` 頁面，採用 2x2 網格佈局，提升視覺清晰度和操作直覺性。
- **CSS 樣式外部化**：將 `admin.html` 的內聯樣式移至專用的 `static/css/admin.css` 檔案，使程式碼更整潔、易於維護。

### v3.5 版本亮點
- **前端互動與 API 呼叫問題修復**：
    - 解決了刪除操作時「Method Not Allowed」錯誤，確保前端使用正確的 HTTP 方法呼叫後端 API。
    - 修正了建立輪播群組時「Token is missing!」錯誤，確保請求帶有 JWT 認證資訊。
    - 優化了群組圖片上傳體驗，上傳後不再彈出提示或重新整理頁面，而是即時更新圖片列表。
    - 修正了指派輪播組時「指派到區塊」下拉選單消失的問題。
    - 解決了指派輪播組時「不支援的操作類型」錯誤，確保前端傳遞正確的資料類型給後端。
    - 修正了刪除輪播群組時，未能正確清理所有群組專屬圖片的問題。

### v3.3 版本亮點
- **群組圖片上傳優化**：修復上傳成功後的彈窗問題，提供更流暢的用戶體驗。
- **JavaScript 作用域修復**：解決函數定義衝突和作用域問題。
- **上傳體驗改善**：移除不必要的成功確認彈窗，圖片上傳後直接顯示在可用列表中。

---

## 核心功能

* **使用者認證**:
    * 透過 JWT (JSON Web Token) 保護所有後台管理 API。
    * 提供獨立的登入頁面 (`/login`) 及平滑的認證檢查載入畫面。

* **現代化的管理介面**:
    * **(v3.4 新增)** 採用 2x2 網格佈局，清晰劃分四大功能區塊：
        1.  **新增媒體 / 指派內容**
        2.  **全局播放設定**
        3.  **媒體庫與區塊內容指派**
        4.  **管理輪播圖片組**

* **媒體素材管理**:
    * 支援上傳圖片和影片素材，並可重新指派未使用的素材。
    * **(v3.3 新增)** 支援群組專屬的多圖片上傳。

* **輪播圖片組管理**:
    * 允許建立、命名和刪除「輪播圖片組」。
    * 提供視覺化的 Modal 彈出視窗，方便地將媒體庫中的圖片加入或移出，並支援拖曳排序。
    * **(v3.1 新增)** 智能素材狀態顯示，包括「已指派」和「在其他群組」標籤。

* **內容指派與播放設定**:
    * 可將單一媒體或整個輪播組指派到前端的特定區塊。
    * 支援設定輪播組的播放**偏移量 (Offset)**。
    * 可在後台設定全局的輪播**間隔時間**。

* **即時更新**:
    * 後台所有變更都會透過 **WebSocket** (Socket.IO) 即時同步到前端顯示頁面，無需重新整理。

---

## 技術棧

* **後端**: Python 3.x, Flask, Flask-SQLAlchemy, Flask-SocketIO, PyJWT, Flask-CORS
* **前端**: 原生 JavaScript (ES6+), Socket.IO Client, Bulma (CSS 框架)
* **資料庫**: SQLite (用於儲存使用者帳號密碼)
* **資料儲存**: `media.json` (媒體與指派資料), `settings.json` (播放設定)
* **部署**: 支援 Linux/macOS/Windows，建議使用虛擬環境

---

## 專案結構

```markdown
MQ-CMS
├── app.py                  # Flask 主應用程式
├── init_db.py              # 資料庫初始化腳本
├── media.json              # 媒體與內容指派資料檔案
├── settings.json           # 全局播放設定檔案
├── requirements.txt        # Python 依賴套件
├── static/
│   ├── css/
│   │   ├── admin.css       # (v3.4 新增) 後台專用樣式表
│   │   ├── bulma.css
│   │   └── index.css
│   ├── js/
│   │   ├── admin.js        # 後台管理頁面的主要邏輯
│   │   └── animation.js    # 前端顯示頁面的動畫與資料邏輯
│   └── uploads/            # 上傳的媒體檔案存放處
└── templates/
    ├── admin.html          # 後台管理頁面
    ├── display.html        # 前端廣告機顯示頁面
    └── login.html          # 登入頁面
```

---

## 未來優化方向與計劃

為了讓專案更健壯、可擴展且易於維護，建議未來可以從以下幾個方向進行優化：

### 1. 後端 API 重構 (RESTful API)
* **現狀**: 目前的後端 API 端點較為混合，例如 `/admin/add` 和 `/admin/delete/<item_id>` 同時處理多種類型的操作（新增素材、指派群組、刪除素材、刪除指派等），這使得後端邏輯變得複雜且不易維護。
* **優化建議**: 將 API 重構為更符合 RESTful 風格的結構，為每種「資源」建立專屬的端點。
    * **媒體素材**: `GET /api/materials`, `POST /api/materials`, `DELETE /api/materials/<id>`
    * **輪播群組**: `GET /api/groups`, `POST /api/groups`, `PUT /api/groups/<id>`, `DELETE /api/groups/<id>`
    * **內容指派**: `GET /api/assignments`, `POST /api/assignments`, `PUT /api/assignments/<id>`, `DELETE /api/assignments/<id>`
    * **全局設定**: `GET /api/settings`, `PUT /api/settings`
* **優點**: 使 API 語義清晰，職責單一，降低程式碼耦合度，方便未來擴展和除錯。

### 2. 資料庫整合 (棄用 JSON 檔案)
* **現狀**: 專案使用 `media.json` 和 `settings.json` 來儲存核心業務資料。這種方式在多人操作或高併發場景下，容易發生資料覆蓋或讀寫衝突，且不利於資料查詢和擴展。
* **優化建議**: 將 JSON 檔案中的資料模型遷移至 SQLite 資料庫中。使用 Flask-SQLAlchemy 建立新的資料模型 (Models)，例如：
    * `Material` (媒體素材)
    * `CarouselGroup` (輪播群組)
    * `Assignment` (內容指派)
    * `Setting` (全局設定)
* **優點**: 享受資料庫帶來的 ACID 事務、資料完整性、索引查詢等優勢，徹底解決檔案讀寫的潛在風險，並為未來更複雜的查詢功能（如：搜尋媒體）打下基礎。

### 3. 前端狀態管理與模組化
* **現狀**: `admin.js` 檔案承擔了所有前端邏輯，包括 API 請求、DOM 操作和事件處理，已變得相當龐大。資料狀態散落在從 `admin.html` 傳遞的全局變數 (`allMediaItemsForJS`) 和各個函式的內部變數中，難以追蹤和管理。
* **優化建議**:
    * **狀態管理**: 引入輕量級的狀態管理模式。與其將所有資料一次性注入 HTML，不如讓 `admin.js` 在載入時主動透過 API 獲取所需資料，並存放在一個統一的狀態物件中。所有對資料的修改都應先更新這個狀態物件，再由狀態驅動 UI 的重新渲染。
    * **模組化**: 將 `admin.js` 拆分為多個關注點分離的模組，例如 `api.js` (處理所有 fetch 請求)、`ui.js` (處理 DOM 更新和通知)、`groupModal.js` (處理輪播組 Modal 的專屬邏輯) 等。
* **優點**: 提高前端程式碼的可讀性、可維護性和可測試性。資料流變得清晰可控，降低了因狀態不同步導致的 bug。

### 4. 增加自動化測試
* **現狀**: 專案缺乏自動化測試，這使得任何重構或新增功能都伴隨著風險，難以確保舊有功能不受影響。
* **優化建議**:
    * **後端測試**: 引入 `pytest` 框架，針對重構後的各個 API 端點編寫單元測試和整合測試，確保資料庫操作和業務邏輯的正確性。
    * **前端測試**: 引入 `Jest` 等測試框架，對拆分後的 JavaScript 模組進行單元測試，驗證各種資料處理函式的正確性。
* **優點**: 大幅提升專案的穩定性和可靠性，讓開發者能更有信心地進行修改和迭代。

### 5. 使用者管理功能
* **現狀**: `init_db.py` 腳本會建立一個密碼寫死的 `admin` 帳號，存在安全風險，且沒有提供管理員增刪改查其他使用者的介面。
* **優化建議**: 在後台新增一個「使用者管理」區塊，允許授權的管理員（例如第一個建立的 admin）新增、編輯、停用或刪除其他使用者帳號，並提供修改自己密碼的功能。
* **優點**: 提升系統的安全性與管理彈性。

---

### 開發者注意事項
- 建議使用 Python 3.8 或更高版本。
- 在生產環境中請務必修改預設密碼，或透過未來的「使用者管理」功能進行調整。
- 定期備份 `instance/users.db` 資料庫檔案。
- 監控 `static/uploads/` 目錄的磁碟空間使用情況。
